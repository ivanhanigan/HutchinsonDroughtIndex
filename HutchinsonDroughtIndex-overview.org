#+TITLE:HutchinsonDroughtIndex overview org 
#+AUTHOR: Ivan Hanigan
#+email: ivan.hanigan@anu.edu.au
#+LaTeX_CLASS: article
#+LaTeX_CLASS_OPTIONS: [a4paper]
#+LATEX: \tableofcontents
-----
* Intro
Monthly drought data for Australia 1890-2008 using the Hutchinson Drought Index  [anudc:3313]
The algorithm used to calculate the drought index using the Hutchinson method is stored in this repository. 


Hanigan, Ivan (2012): Monthly drought data for Australia 1890-2008 using the Hutchinson Drought Index. Australian National University Data Commons. DOI: 10.4225/13/50BBFD7E6727A.
http://dx.doi.org/10.4225/13/50BBFD7E6727A

* TODO-list

** DONE add gh-pages

** TODO identify key components for web page

** TODO publish station data set to AEKOS
** TODO follow up publication to ADA
-----Original Message-----
From: Steven McEachern
Sent: Wednesday, January 7, 2015 2:27 PM
To: Ivan Hanigan
Cc: ada@anu.edu.au
Subject: Re: Drought Data
 
Hi Ivan,
 
I¹ve added the CSV files and the R script to our archive in zip format.
The data is now stored in our deposit system and has the ADA ID number 01280.
 
Once we¹ve processed the data and published it, it will then be available
at: http://www.ada.edu.au/ada/01280 (but not yet).
 
I¹ll need to get you to sign off a license agreement (available at: ), and we may need to follow up with some additional metadata, but for now it¹s stored away.
If users want the data we will be able to provide it on request, but once we publish it we can make it available online.
 
Re the License, I need to do some exploratory work with Nesstar (and Steve
Hassan) to see how we change the access, but will aim to get this in place. (We have other depositors asking for this as well).
 
Re the copyright - which dataset is that from? It¹s the POA data right?
"Copyright
Copyright © 2011, The Australian National University. All rights reserved.| © Copyright Commonwealth of Australia 2005, Bureau of Meteorology. All rights reserved.| ABS Copyright © Commonwealth of Australia 2001, Australian Bureau of Statistics Census data is licensed under a Creative Commons Attribution 2.5 Australia licence. All rights reserved."
 
We probably need to check with IP folks to confirm - but I think you might be right, if the original data is not part of the dataset we are providing.
 
 
Cheers,
Steve
 
 
 
--------------------------------
Steven McEachern
Director and Manager
Australian Data Archive
steven.mceachern@anu.edu.au
Ph. (+61) 02 6125 2200
--------------------------------
* ad hoc
** prospect dam
*** COMMENT hack-code
#+name:hack
#+begin_src R :session *R* :tangle no :exports none :eval no
  #### name:hack####
  
  
  
  # hack middle src load
  df <- read.csv("data/ad_hoc/IDCJAC0001_067019/IDCJAC0001_067019_Data1.csv")
  # create df5
  
   drt <- droughtIndex(data=df5,years=length(names(table(df5$year))))
   qc3=drt[drt$year>=1979 & drt$year < 1984,]
  write.csv(drt, file.path('data/ad_hoc','ProspectReservoir06719Drought8283.csv'), row.names = F)
   png(file.path('data/ad_hoc','ProspectReservoir06719Drought8283.png'),res=200,width = 2100, height = 1000)
   par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
   plot(qc3$date,qc3$rain,type='l',main='Prospect Reservoir (67019) NSW: raw monthly rainfall')
   #points(qc3$date,qc3$rain)
   
   lines(qc3$date,qc3$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
   points(qc3$date,qc3$sixmnthtot/6)
   
   plot(qc3$date,qc3$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
   points(qc3$date,qc3$index)
   segments(min(qc3$date),-1,max(qc3$date),-1)
   segments(min(qc3$date),0,max(qc3$date),0,lty=2)
   plot(qc3$date,qc3$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
   points(qc3$date,qc3$count)
   segments(min(qc3$date),5,max(qc3$date),5)
   
   plot(qc3$date,qc3$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
   points(qc3$date,qc3$count2)
   segments(min(qc3$date),5,max(qc3$date),5)
   dev.off()
  
#+end_src
*** COMMENT kwrt_weather_drought_1888_2014_p141.Rmd
[[./reports/kwrt_weather_drought_1888_2014_p141.Rmd]]
**** old 
#+begin_src R :session *shell* :tangle no :exports none :eval no
  ---
  title: "kwrt weather drought 1888 2014 p141"
  author: Ivan C. Hanigan
  output:
    html_document:
      toc: true
      theme: united
      number_sections: no    
    pdf_document:
      toc: true
      toc_depth: 3
      highlight: zenburn
      keep_tex: true
      number_sections: no        
  documentclass: article
  classoption: a4paper
  ---
  
  
    
  ```{r echo = F, eval=F, results="hide"}
  # func
  setwd("~/data/HutchinsonDroughtIndex/reports/")
  library(rmarkdown)
  library(knitr)
  library(knitcitations)
  cleanbib()
  options("cite_format"="pandoc")
  rmarkdown::render("kwrt_weather_drought_1888_2014_p141.Rmd", "all")
  # browseURL("hanigan-synthesis.html")
  system("pandoc -V papersize:'a4paper' -i hanigan-synthesis.html -o hanigan-synthesis.docx")
  ```
  ```{r, echo = F, results = 'hide'}
  # load
  if(!exists("bib")){
  bib <- read.bibtex("~/references/library.bib")
  }
  ```
  
  ## Introduction
  
  This is the code to calculate the Drought Data for the Hutchinson Drought Index  `r citet(bib[["Kokic2006a"]])` application to the Woodland Restoration Plot Network.
  
  First do a quality assurance test with the Prospect Reservoir data, then apply to the woodland restoration plot network spatial locations.
  
  ## Data Source
  
  - The Bureau of Meteorology has generated a range of gridded meteorological datasets for Australia as a contribution to the Australian Water Availability Project (AWAP). These include monthly precipitation from 1900 to the present.
  - [http://www.bom.gov.au/jsp/awap/](http://www.bom.gov.au/jsp/awap/)
  - Documentation is at [http://www.bom.gov.au/amm/docs/2009/jones.pdf](http://www.bom.gov.au/amm/docs/2009/jones.pdf)
  
  
  ```{r, echo = F, eval = F, results = 'hide'}
  #### install dependencies
  library(disentangle)
  require(swishdbtools)
  if(!require(raster)) install.packages("raster", dependencies = T); require(raster)
  if(!require(rgdal)) install.packages("rgdal", dependencies = T); require(rgdal)
  library(sqldf)  
  # on linux can install direct, on windoze you configure Rtools
  #require(devtools)
  #install_github("swish-climate-impact-assessment/awaptools")
  require(awaptools)
  #install_github("ivanhanigan/HutchinsonDroughtIndex")
  
  homedir <- "~/data/HutchinsonDroughtIndex/reports"
  outdir <- "/ResearchData/AWAP_GRIDS_RAIN_MONTHLY"
   
  # first make sure there are no left over files from previous runs
  #oldfiles <- list.files(pattern = '.tif', full.names=T) 
  #for(oldfile in oldfiles)
  #{
  #  print(oldfile)
  #  file.remove(oldfile)
  #}
  ################################################
  setwd(homedir)
   
  # local customisations
  workdir  <- outdir
  setwd(workdir)
  dir()
  # don't change this
  # years <- c(2013:2014)
  # lengthYears <- length(years)
  # change this
  startdate <- "2014-01-01"
  enddate <- "2014-12-31"
  # do
  load_monthly(start_date = startdate, end_date = enddate)
   
  # do
  filelist <- dir(pattern = "grid.Z$")
  filelist
  for(fname in filelist)
  {
    #fname <- filelist[1]
    unzip_monthly(fname, aggregation_factor = 1)
    fin <- gsub(".grid.Z", ".grid", fname)
    fout <- gsub(".grid.Z", ".tif", fname)
    r <- raster(fin)
    writeRaster(r, fout, format="GTiff",  overwrite = TRUE)
    file.remove(fin)
  }
   
  cfiles <- list.files(pattern = '.tif', full.names=T) 
  matrix(cfiles)
  ```
  
  ## Methods
  
  The Drought index is shown in Figure
  X for the SD of Central West NSW
  during a period which includes a strong drought (1979-83). The raw
  monthly rainfall totals are integrated to rolling 6-monthly totals
  (both shown in first panel) which are then ranked into percentiles by
  month and this is rescaled to range between -4 and +4 in keeping with
  the range of the Palmer Index Palmer1965 (second panel). Mild
  drought is below -1 in the Palmer index and so consecutive months
  below this threshold are counted. In the original method 5 or more
  consecutive months was defined as the beginning of a drought, which
  continued until the rescaled percentiles exceed -1 again (third
  panel). The enhanced method imposes a more conservative threshold of
  zero (the median) to break a drought (fourth panel).  There was also
  an alternative method devised by Hutchinson where the rescaled
  percentile values are integrated using conditional cumulative
  sums.
  
  ## Results
  
  Shown in Figure Y is the results
  
  ![alttext](kwrt_weather_drought_1888_2014_p141_output3.png)
  
  ```{r, echo = F, eval = F, results = 'hide'}
  library(awaptools)
  library(swishdbtools)
  library(gisviz)
  if(!library(raster)) install.packages('raster'); library(raster)
  library(sqldf)
  
  homedir <- "~/data/HutchinsonDroughtIndex/reports"
  outdir <- "/ResearchData/AWAP_GRIDS_RAIN_MONTHLY"
  setwd(outdir)
  
  locn <- geocode("PROSPECT RESERVOIR NSW")
  epsg <- make_EPSG()
  shp <- SpatialPointsDataFrame(cbind(locn$lon,locn$lat),locn,
                                proj4string=CRS(epsg$prj4[epsg$code %in% '4283']))
  shp@data 
  ##        lon       lat
  ## 1 150.8929 -33.82107
  
  cfiles <-  dir(pattern="tif$")
  cfiles[1:10]
  tail(cfiles)
  for(i in seq_len(length(cfiles))){
    #i <- 1 ## for stepping thru
    gridname <- cfiles[[i]]
    r <- raster(gridname)
    e <- extract(r, shp, df=T)
    e1 <- shp
    e1@data$values <- e[,2]
    e1@data$gridname <- gridname
    # e1@data
    # write to to target file
    write.table(e1@data, file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output.csv"),
      col.names = i == 1, append = i>1 , sep = ",", row.names = FALSE)
  }
  dat <- read.csv(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output.csv"))
  head(dat)
  tail(dat)
  qc2 <- read.csv("~/data/HutchinsonDroughtIndex/data/ad_hoc/IDCJAC0001_067019_Data1.csv")
  names(qc2) <- lcu(names(qc2))
  head(qc2)
  tail(qc2)
  dat$raster_layer <- as.character(dat$gridname)
  dat$date <- matrix(unlist(strsplit(dat$raster_layer, "_")), ncol = 2, byrow=TRUE)[,2]
  head(dat)
  dat$date <- gsub(".tif","",dat$date)
  head(dat )
  dat$date <- paste(substr(dat$date,1,4), substr(dat$date,5,6), substr(dat$date,7,8), sep = "-")
  head(dat )
  dat$year <- substr(dat$date,1,4)
  dat$month <- substr(dat$date,6,7)
  dat$year <- as.numeric(dat$year)
  dat$month <- as.numeric(dat$month)
  dat$date <- as.Date(dat$date)
  str(dat)
  
  qc <- dat
  qc3 <- sqldf("select * from qc left join qc2 on qc.year = qc2.year and
    qc.month = qc2.month")
  head(qc3)
  tail(qc3)
  
  png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output1.png"))
  with(qc3, plot(monthly_precipitation_total_millimetres_, values))
  dev.off()
  
  png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output2.png"))
  with(qc3, plot(as.Date(date), values, type = "l"))
  with(qc3, lines(as.Date(date), monthly_precipitation_total_millimetres_, col = "blue"))
  dev.off()
  
  qc3[is.na(qc3$monthly_precipitation_total_millimetres_),]
  
  require(HutchinsonDroughtIndex)
  
  qc4 <- sqldf("select * from qc3 where year < 2013")
  head(qc4);tail(qc4)
  qc4$rain <- qc4$values
  as.data.frame(table(qc4$year))
  indat <- qc4[,c("date","year","month","rain")]
  str(indat)
  indat[(nrow(indat) - 20):nrow(indat),]
  
  
  drt <- drought_index_stations(data=indat,
  years=length(names(table(indat$year)))
  )
  head(drt)
  tail(drt)
  str(drt)
  qc3 <- drt[drt$year>=1979 & drt$year < 1984,]
  
  png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output3.png"))
  par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
   plot(qc3$date,qc3$rain,type='l',main='Prospect Reservoir (67019) NSW: raw monthly rainfall')
   #points(qc3$date,qc3$rain)
   
   lines(qc3$date,qc3$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
   points(qc3$date,qc3$sixmnthtot/6)
   
   plot(qc3$date,qc3$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
   points(qc3$date,qc3$index)
   segments(min(qc3$date),-1,max(qc3$date),-1)
   segments(min(qc3$date),0,max(qc3$date),0,lty=2)
   plot(qc3$date,qc3$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
   points(qc3$date,qc3$count)
   segments(min(qc3$date),5,max(qc3$date),5)
   
   plot(qc3$date,qc3$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
   points(qc3$date,qc3$count2)
   segments(min(qc3$date),5,max(qc3$date),5)
  dev.off()
  
  
  ```
  
  ## Conclusions
  
  The end
  
  ## References
  
  ```{r, results = 'asis', echo = FALSE}
  bibliography()
  ```
  
#+end_src
* R
** COMMENT droughtIndex_future
#+name:droughtIndex_future
#+begin_src R :session *shell* :tangle code/droughtIndex_future.R :exports none :eval no
  # now to setup the drought algorithm to use the thresholds from the
  # historical record, to benchmark the projected future distribution
  
  #### name:droughtIndex_future ####
  droughtIndex_future <- function(data,years,droughtThreshold=.375){
  # a drought index based on integrated six-monthly rainfall percentiles.
  # based on Professor Mike Hutchinson's work described in
  # Smith D, Hutchinson M, McArthur R. Climatic and Agricultural Drought: Payments and Policy.
  # Canberra, ACT: Centre for Resource and Environmental Studies, Australian National University. 1992.
  
  # Ivan C Hanigan
  # June 2011.
  # GPL2
  # for updates please see https://github.com/ivanhanigan/HutchinsonDroughtIndex.
  
  # my input data are always a data.frame with 5 columns 'date (future','year(future)','month','rain(past)' 'rain_projected'
  
  #### PAST DISTRIBUTION  
  #calculate M month totals
  # started with 6 (current and prior months)
    
  # ASSUMES PAST RAIN IS IN FOURTH COLUMN  
  x<-ts(data[,4],start=1,end=c(years,12),frequency=12)
  x<-c(rep(NA,5),x+lag(x,1)+lag(x,2)+lag(x,3)+lag(x,4)+lag(x,5))
  data$sixmnthtot<-x
  #data<-na.omit(data)
  #### FUTURE RAIN
  # ASSUMES FUTURE IS IN COL 5
  x2<-ts(data[,5],start=1,end=c(years,12),frequency=12)
  x2<-c(rep(NA,5),x2+lag(x2,1)+lag(x2,2)+lag(x2,3)+lag(x2,4)+lag(x2,5))
  data$sixmnthtot2<-x2
  data<-na.omit(data)
  #head(data)
  #tail(data)
  # rank in percentage terms with respect to the rainfall totals
  # for the same sequence of 6-months over all years of record
  dataout_final=matrix(nrow=0,ncol=7)
  
  for(i in 1:12){
    #i =1
    # col sixmnthto is the past rain, sixmnthtot2 is the future rain
  x<-data[data$month==i,'sixmnthtot']
  x2<-data[data$month==i,'sixmnthtot2']
  
  #x<-na.omit(x)
  # get distribution of FUTURE RAIN
  y <- (rank(x2)-1)/(length(x2)-1)
  # checkpct<-cbind(data[data$month==i,],y)
  # plot(checkpct$sixmnthtot,checkpct$y)
  # rescale between -4 and +4 to replicate palmer index
  z <- 8 * (y - .5)
  # defaults set the threshold at -1 which is upper limit of mild drought in palmer index (3/8ths, or the 37.5th percentile)
  # use future rain < past rain threshold
  drought <- x2 <= quantile(x,droughtThreshold)
  
  # calculate the drought index for any months that fall below the threshold
  zd <- z * drought
  # save out to the data
  dataout<-data[data$month==i,]
  dataout$index<-z
  dataout$indexBelowThreshold<-zd
  dataout_final=rbind(dataout_final,dataout)
  }
  
  data<-dataout_final[order(dataout_final$date),]
  
  # now calculate the indices
  data$count<-as.numeric(0)
  
  for(j in 2:nrow(data)){
    data$count[j] <- ifelse(data$indexBelowThreshold[j]==0,0,
      ifelse(data$indexBelowThreshold[j-1]!=0,1+data$count[j-1],1)
    )
  }
  
  # enhanced drought revocation threshold
  # In the enhanced version rather than stop counting when the rescaled percentiles rise above -1.0,
  # we keep counting the months (or adding the negative anomalies)
  # if the rescaled percentile is below 0.0 AND the drought threshold has already been reached.
  # If the threshold has not been reached, then stop counting (or adding) as before
  # if the rescaled percentile rises above -1.0.
  
  data$count2<-data$count
  # j=1080 # 1980-06
  # data[j,]
  
  for(j in 2:nrow(data)){
    data$count2[j] <- if(data$count2[j-1] >= 5 & data$index[j] <= 0){
      data$count2[j-1] + 1
    } else {
  # ifelse(data$count[j-1] > 0 & data$index[j] < 0, 1+data$count[j-1],
      data$count2[j]
    }
  }
  
  
  data$sums<-as.numeric(0)
  
  for(j in 2:nrow(data)){
  data$sums[j]<-ifelse(data$indexBelowThreshold[j]==0,0,
  ifelse(data$indexBelowThreshold[j-1]!=0,
  data$indexBelowThreshold[j]+data$sums[j-1],
  data$indexBelowThreshold[j]))
  }
  
  
  data$sums2<-data$sums
  # j=1069 # 1980-06
  # data[j,]
  
  for(j in 2:nrow(data)){
  data$sums2[j] <- if(data$sums2[j-1] <= -17.5 & data$index[j] <= 0){
  data$sums2[j-1] + data$index[j]
  } else {
  # ifelse(data$count[j-1] > 0 & data$index[j] < 0, 1+data$count[j-1],
  data$sums2[j]
  }
  }
  #plot(data$date, data$count, type = "l")
  #abline(5,0)
  droughtIndices<-data
  
  return(droughtIndices)
  }
  
#+end_src

