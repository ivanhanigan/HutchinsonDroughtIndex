<!-- --- -->
<!-- title: "kwrt weather drought 1888 2014 p141" -->
<!-- author: Ivan C. Hanigan -->
<!-- output: -->
<!--   html_document: -->
<!--     toc: true -->
<!--     theme: united -->
<!--     number_sections: no     -->
<!--   pdf_document: -->
<!--     toc: true -->
<!--     toc_depth: 3 -->
<!--     highlight: zenburn -->
<!--     keep_tex: true -->
<!--     number_sections: no         -->
<!-- documentclass: article -->
<!-- classoption: a4paper -->
<!-- --- -->


  
```{r echo = F, eval=F, results="hide"}
# func
setwd("~/data/HutchinsonDroughtIndex/reports/")
#library(rmarkdown)
library(knitr)
library(knitcitations)
cleanbib()
options("cite_format"="pandoc")
#rmarkdown::render("kwrt_weather_drought_1888_2014_p141.Rmd", "all")
require(markdown)
knit2html("kwrt_weather_drought_1888_2014_p141.Rmd", options = c("toc", markdown::markdownHTMLOptions(TRUE)), stylesheet = "custom.css")
browseURL("kwrt_weather_drought_1888_2014_p141.html")
#system("pandoc -V papersize:'a4paper' -i hanigan-synthesis.html -o hanigan-synthesis.docx")
```
```{r, echo = F, results = 'hide'}
# load
if(!exists("bib")){
bib <- read.bibtex("~/references/library.bib")
}
```

## Introduction

This is the code to calculate the Drought Data for the Hutchinson Drought Index  `r citet(bib[["Kokic2006a"]])` application to the Woodland Restoration Plot Network.

First do a quality assurance test with the Prospect Reservoir data, then apply to the woodland restoration plot network spatial locations.

## Methods

The Drought index is shown in Figure
X for the SD of Central West NSW
during a period which includes a strong drought (1979-83). The raw
monthly rainfall totals are integrated to rolling 6-monthly totals
(both shown in first panel) which are then ranked into percentiles by
month and this is rescaled to range between -4 and +4 in keeping with
the range of the Palmer Index Palmer1965 (second panel). Mild
drought is below -1 in the Palmer index and so consecutive months
below this threshold are counted. In the original method 5 or more
consecutive months was defined as the beginning of a drought, which
continued until the rescaled percentiles exceed -1 again (third
panel). The enhanced method imposes a more conservative threshold of
zero (the median) to break a drought (fourth panel).  There was also
an alternative method devised by Hutchinson where the rescaled
percentile values are integrated using conditional cumulative
sums.

## Data Sources

### Bom Station
- A station from the prospect reservoir

### AWAP
- The Bureau of Meteorology has generated a range of gridded meteorological datasets for Australia as a contribution to the Australian Water Availability Project (AWAP). These include monthly precipitation from 1900 to the present.
- [http://www.bom.gov.au/jsp/awap/](http://www.bom.gov.au/jsp/awap/)
- Documentation is at [http://www.bom.gov.au/amm/docs/2009/jones.pdf](http://www.bom.gov.au/amm/docs/2009/jones.pdf)
### Emast

# Code
## Bom Station

```{r, echo = F, eval =F, results = 'hide'}
#library(devtools)
#install_github("ivanhanigan/HutchinsonDroughtIndex")
library(HutchinsonDroughtIndex)
setwd("~/data/HutchinsonDroughtIndex/")
indir <- "data/ad_hoc"
# go to the bom website to get the link
# http://www.bom.gov.au/climate/data/index.shtml?map_type=cdio&code=1
inurl <-"http://www.bom.gov.au/jsp/ncc/cdio/weatherData/av?p_display_type=monthlyZippedDataFile&p_stn_num=67019&p_c=-898321455&p_nccObsCode=139&p_startYear="
#wd <- getwd()
#setwd(indir)
#download.file(inurl, "temp.zip", mode = "wb")
#unzip("temp.zip")
#setwd(wd)
dir(indir)
df <- read.csv("data/ad_hoc/IDCJAC0001_67019_Data1.csv")
# create df5
head(df)
df$date  <- as.Date(paste(df$Year, df$Month, 1, sep = "-"))
names(df) <- 
df <- df[,c("date","Year","Month","Monthly.Precipitation.Total..millimetres.")]
names(df) <- c("date","year","month","rain")
tail(df)
df5 <- subset(df, year < 2015)
alldates <- merge(1887:2014, 1:12)
names(alldates)  <- c("year", "month")
alldates  <- alldates[order(alldates$year),]
df5 <- merge(alldates, df5, all.x = T)
df5[is.na(df5$rain),]
tail(df5)
# NB the code does not deal with missing months
# so impute with the mean of that month across al time
df5[is.na(df5$rain),]
library(sqldf)
df5 <- sqldf("
select t1.year, t1.month, 
 case when rain is null then t2.avg else rain end as rain
from df5 t1
join
(select month, avg(rain) as avg from df5 group by month) t2
on t1.month = t2.month
order by t1.year, t1.month
 ")
str(df5)
df5$date  <- as.Date(paste(df5$year, df5$month, 1, sep = "-"))
df5 <- df5[,c("date","year","month","rain")]
head(df5)
tail(df5)
##############################################
drt <- drought_index_stations(data=df5,years=length(names(table(df5$year))))

qc3=drt[drt$year>=1979 & drt$year < 1984,]

write.csv(drt, file.path('data/ad_hoc','ProspectReservoir06719Drought8283.csv'), row.names = F)

 png(file.path('data/ad_hoc','ProspectReservoir06719Drought8283.png'),res=200,width = 2100, height = 1000)
 par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
 plot(qc3$date,qc3$rain,type='l',main='Prospect Reservoir (67019) NSW: raw monthly rainfall')
 #points(qc3$date,qc3$rain)
 
 lines(qc3$date,qc3$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
 points(qc3$date,qc3$sixmnthtot/6)
 
 plot(qc3$date,qc3$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
 points(qc3$date,qc3$index)
 segments(min(qc3$date),-1,max(qc3$date),-1)
 segments(min(qc3$date),0,max(qc3$date),0,lty=2)
 plot(qc3$date,qc3$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
 points(qc3$date,qc3$count)
 segments(min(qc3$date),5,max(qc3$date),5)
 
 plot(qc3$date,qc3$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
 points(qc3$date,qc3$count2)
 segments(min(qc3$date),5,max(qc3$date),5)
 dev.off()

```

## AWAP

```{r, echo = F, eval = F, results = 'hide'}
#### install dependencies
library(disentangle)
require(swishdbtools)
if(!require(raster)) install.packages("raster", dependencies = T); require(raster)
if(!require(rgdal)) install.packages("rgdal", dependencies = T); require(rgdal)
library(sqldf)  
# on linux can install direct, on windoze you configure Rtools
#require(devtools)
#install_github("swish-climate-impact-assessment/awaptools")
require(awaptools)
#install_github("ivanhanigan/HutchinsonDroughtIndex")

homedir <- "~/data/HutchinsonDroughtIndex/reports"
outdir <- "~/data/AWAP_GRIDS_RAIN_MONTHLY"
 
# first make sure there are no left over files from previous runs
#oldfiles <- list.files(pattern = '.tif', full.names=T) 
#for(oldfile in oldfiles)
#{
#  print(oldfile)
#  file.remove(oldfile)
#}
################################################
setwd(homedir)
 
# local customisations
workdir  <- outdir
setwd(workdir)
dir()
# don't change this
# years <- c(2013:2014)
# lengthYears <- length(years)
# change this
startdate <- "2014-01-01"
enddate <- "2014-12-31"
# do
load_monthly(start_date = startdate, end_date = enddate)
 
# do
filelist <- dir(pattern = "grid.Z$")
filelist
for(fname in filelist)
{
  #fname <- filelist[1]
  unzip_monthly(fname, aggregation_factor = 1)
  fin <- gsub(".grid.Z", ".grid", fname)
  fout <- gsub(".grid.Z", ".tif", fname)
  r <- raster(fin)
  writeRaster(r, fout, format="GTiff",  overwrite = TRUE)
  file.remove(fin)
}
 
cfiles <- list.files(pattern = '.tif', full.names=T) 
matrix(cfiles)
```



```{r, echo = F, eval = F, results = 'hide'}
#library(devtools)
#install_github("swish-climate-impact-assessment/awaptools")
library(awaptools)
#install_github("swish-climate-impact-assessment/swishdbtools")
library(swishdbtools)
#install_github("ivanhanigan/gisviz")
library(gisviz)
if(!require(raster)) install.packages('raster'); library(raster)
library(sqldf)
library(disentangle)
homedir <- "~/data/HutchinsonDroughtIndex/reports"
dir(homedir)
outdir <- "~/data/AWAP_GRIDS_RAIN_MONTHLY"
setwd(outdir)

locn <- geocode("PROSPECT RESERVOIR NSW")
epsg <- make_EPSG()
shp <- SpatialPointsDataFrame(cbind(locn$lon,locn$lat),locn,
                              proj4string=CRS(epsg$prj4[epsg$code %in% '4283']))
shp@data 
##        lon       lat
## 1 150.8929 -33.82107
wd <- getwd()
setwd(homedir)
writeOGR(shp, 'prospect.shp', 'prospect', driver='ESRI Shapefile')
setwd(wd)
cfiles <-  dir(pattern="tif$")
cfiles[1:10]
tail(cfiles)
for(i in seq_len(length(cfiles))){
  #i <- 1 ## for stepping thru
  gridname <- cfiles[[i]]
  r <- raster(gridname)
  e <- extract(r, shp, df=T)
  e1 <- shp
  e1@data$values <- e[,2]
  e1@data$gridname <- gridname
  # e1@data
  # write to to target file
  write.table(e1@data, file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output.csv"),
    col.names = i == 1, append = i>1 , sep = ",", row.names = FALSE)
}
dat <- read.csv(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output.csv"))
head(dat)
tail(dat)
qc2 <- read.csv("~/data/HutchinsonDroughtIndex/data/ad_hoc/IDCJAC0001_67019_Data1.csv")
names(qc2) <- lcu(names(qc2))
head(qc2)
tail(qc2)
dat$raster_layer <- as.character(dat$gridname)
dat$date <- matrix(unlist(strsplit(dat$raster_layer, "_")), ncol = 2, byrow=TRUE)[,2]
head(dat)
dat$date <- gsub(".tif","",dat$date)
head(dat )
dat$date <- paste(substr(dat$date,1,4), substr(dat$date,5,6), substr(dat$date,7,8), sep = "-")
head(dat )
dat$year <- substr(dat$date,1,4)
dat$month <- substr(dat$date,6,7)
dat$year <- as.numeric(dat$year)
dat$month <- as.numeric(dat$month)
dat$date <- as.Date(dat$date)
str(dat)

qc <- dat
qc3 <- sqldf("select * from qc left join qc2 on qc.year = qc2.year and
  qc.month = qc2.month")
head(qc3)
tail(qc3)

#png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output1.png"))
##with(qc3, plot(monthly_precipitation_total_millimetres_, values))
#dev.off()

## png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output2.png"))
## with(qc3, plot(as.Date(date), values, type = "l"))
## with(qc3, lines(as.Date(date), monthly_precipitation_total_millimetres_, col = "blue"))
## dev.off()

qc3[is.na(qc3$monthly_precipitation_total_millimetres_),]

require(HutchinsonDroughtIndex)
head(qc3);tail(qc3)
qc4 <- sqldf("select * from qc3 where year < 2015")
head(qc4);tail(qc4)
qc4$rain <- qc4$values
as.data.frame(table(qc4$year))
indat <- qc4[,c("date","year","month","rain")]
str(indat)
indat[(nrow(indat) - 20):nrow(indat),]


drt <- drought_index_stations(data=indat,
years=length(names(table(indat$year)))
)
head(drt)
tail(drt)
str(drt)
write.csv(drt, "kwrt_weather_drought_1888_2014_p141_output_awap.csv", row.names = F)
qc3 <- drt[drt$year>=1979 & drt$year < 1984,]

png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output_awap.png"))
par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
 plot(qc3$date,qc3$rain,type='l',main='Prospect Reservoir (67019) NSW: raw monthly rainfall (AWAP)')
 #points(qc3$date,qc3$rain)
 
 lines(qc3$date,qc3$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
 points(qc3$date,qc3$sixmnthtot/6)
 
 plot(qc3$date,qc3$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
 points(qc3$date,qc3$index)
 segments(min(qc3$date),-1,max(qc3$date),-1)
 segments(min(qc3$date),0,max(qc3$date),0,lty=2)
 plot(qc3$date,qc3$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
 points(qc3$date,qc3$count)
 segments(min(qc3$date),5,max(qc3$date),5)
 
 plot(qc3$date,qc3$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
 points(qc3$date,qc3$count2)
 segments(min(qc3$date),5,max(qc3$date),5)
dev.off()


```

## EMAST

```{r, echo =F, eval = F, results='hide'}

setwd("~/data/brains-prod/home/ivan_hanigan/data/grids_emast/data")
# ref http://www.emast.org.au/observations/climate/
#install.packages("ncdf", type = "source", configure.args="--with-netcdf-include=/usr/include")
require(ncdf)

## Loading required package: ncdf

#install.packages("raster", dependencies = T)
require(raster)

## Loading required package: raster
## Loading required package: sp

# install.packages("rgdal")
require(rgdal)

# Loading required package: rgdal
# rgdal: version: 0.9-1, (SVN revision 518)
# Geospatial Data Abstraction Library extensions to R successfully loaded
# Loaded GDAL runtime: GDAL 1.9.2, released 2012/10/08
# Path to GDAL shared files: /usr/share/gdal
# Loaded PROJ.4 runtime: Rel. 4.8.0, 6 March 2012, [PJ_VERSION: 480]
# Path to PROJ.4 shared files: (autodetected)

#if extracting for points shapefile
require(ggmap)
require(rgdal)
locn <- geocode("Prospect Reservoir NSW")
# this uses google maps API, better check this

## Treat data frame as spatial points
epsg <- make_EPSG()
shp <- SpatialPointsDataFrame(cbind(locn$lon,locn$lat),locn,
                              proj4string=CRS(epsg$prj4[epsg$code %in% '4283']))
str(shp)
shp@data
# #writeOGR(shp, 'test.shp', 'test', driver  = "ESRI Shapefile")
# 
# #shp <- readOGR(dsn="test.shp", layer='test')
# #plot(shp, add = T)
# 
# # a loop through days, see comment sections that print for debugging
# strt <-'2012-01-01'
# end <- '2012-01-04'
# dates <- seq(as.Date(strt),as.Date(end),1)          
# dates
# 
# ## [1] "2012-01-01" "2012-01-02" "2012-01-03" "2012-01-04"
# 
# # if extracting to shp then set up an output dataframe to collect
# dat_out <- as.data.frame(matrix(nrow = 0, ncol = 4))
# # else just plots
# par(mfrow = c(2,2))
# for(i in 1:length(dates)){
#   #  i=1
#   date_i <- dates[i]
#   infile <- sprintf("http://dapds00.nci.org.au/thredds/dodsC/rr9/Climate/eMAST/ANUClimate/0_01deg/v1m0_aus/day/land/tmin/e_01/2012/eMAST_ANUClimate_day_tmin_v1m0_%s.nc", gsub("-", "", date_i))
#   
#   nc <- open.ncdf(infile)
#   vals <- get.var.ncdf(nc, varid="air_temperature")
#   nc.att <- nc$var$air_temperature
#   xmin <- min(nc.att$dim[[1]]$vals)
#   xmax <- max(nc.att$dim[[1]]$vals)
#   ymin <- min(nc.att$dim[[2]]$vals)
#   ymax <- max(nc.att$dim[[2]]$vals)
#   
#   print(c(xmin,xmax))
#   print(c(ymin,ymax))
#   
#   r <- raster(t(vals),
#               xmn=xmin, xmx=xmax,
#               ymn=ymin, ymx=ymax)
#   #str(r)
#   plot(r)
#   title(date_i)
#   #image(r)
#   e <- extract(r, shp, df=T)
#   #str(e) 
#   e1 <- shp@data
#   e1$date <- date_i
#   e1$values <- e[,2]
#   dat_out <- rbind(dat_out, as.data.frame(e1))
# }
# dat_out
# 
# # monthly
# "http://dap.nci.org.au/thredds/remoteCatalogService?command=subset&catalog=http://dapds00.nci.org.au/thredds/catalog/rr9/Climate/eMAST/ANUClimate/0_01deg/v1m0_aus/mon/land/prec/e_01/1970_2012/catalog.xml&dataset=rr9/Climate/eMAST/ANUClimate/0_01deg/v1m0_aus/mon/land/prec/e_01/1970_2012/eMAST_ANUClimate_mon_prec_v1m0_197001.nc"
# strt <-'1976-01-01'
# end <- '2012-12-31'
# #dates <- paste(strt:end, 1:12)
# dates <- seq(as.Date(strt),as.Date(end),31) 
yy <- as.data.frame(1970:2012)
mm <- as.data.frame(c("01","02","03","04","05","06","07","08","09","10","11","12"))
library(sqldf)
dates <- sqldf("select * from yy, mm")
head(dates)
dates <- paste(dates[,1], dates[,2], sep = "")
head(dates)
dates[1:10]
#dat_out <- as.data.frame(matrix(nrow = 0, ncol = 4))
# else just plots
#par(mfrow = c(2,2))
# setwd("data")
cfiles <-  dir(pattern="tif$")
cfiles[1:10]
tail(cfiles)
length(cfiles)
dates[426]
system("df -h")
## for(i in 426:length(dates)){
##   #  i=183
##   date_i <- gsub("-", "", substr(dates[i],1,7))
##   print(date_i)
##   infile <- sprintf("http://dapds00.nci.org.au/thredds/dodsC/rr9/Climate/eMAST/ANUClimate/0_01deg/v1m0_aus/mon/land/prec/e_01/1970_2012/eMAST_ANUClimate_mon_prec_v1m0_%s.nc", gsub("-", "", date_i))
##   #infile
##   nc <- open.ncdf(infile)
##   #str(nc)
##   vals <- get.var.ncdf(nc, varid="lwe_thickness_of_precipitation_amount")
##   nc.att <- nc$var$lwe_thickness_of_precipitation_amount
##   xmin <- min(nc.att$dim[[1]]$vals)
##   xmax <- max(nc.att$dim[[1]]$vals)
##   ymin <- min(nc.att$dim[[2]]$vals)
##   ymax <- max(nc.att$dim[[2]]$vals)
  
##   #  print(c(xmin,xmax))
##   #  print(c(ymin,ymax))
  
##   r <- raster(t(vals),
##               xmn=xmin, xmx=xmax,
##               ymn=ymin, ymx=ymax)
##   #str(r)
##   #  plot(r)
##   #  title(date_i)
##   writeRaster(r, paste("precipitation_",date_i,".tif",sep=''), format="GTiff")
              
##   #image(r)
##   #e <- extract(r, shp, df=T)
##   #str(e) 
##   #e1 <- shp@data
##   #e1$date <- date_i
##   #e1$values <- e[,2]
##   #dat_out <- rbind(dat_out, as.data.frame(e1))
##   #write.table(e1, file.path("kwrt_weather_drought_1888_2014_p141_output_grids_emast.csv"),
##   #            col.names = i == 1, append = i>1 , sep = ",", row.names = FALSE)
##   Sys.sleep(time = 2)
## }
#dat_out


cfiles <-  dir(pattern="tif$")
cfiles[1:10]
tail(cfiles)
for(i in seq_len(length(cfiles))){
  #i <- 1 ## for stepping thru
  gridname <- cfiles[[i]]
  r <- raster(gridname)
  e <- extract(r, shp, df=T)
  e1 <- shp
  e1@data$values <- e[,2]
  e1@data$gridname <- gridname
  # e1@data
  # write to to target file
  write.table(e1@data, file.path("~/data/HutchinsonDroughtIndex/reports", "kwrt_weather_drought_1888_2014_p141_output_grids_emast.csv"),
              col.names = i == 1, append = i>1 , sep = ",", row.names = FALSE)
}

############################################################################################
setwd("~/data/HutchinsonDroughtIndex/reports")
dir(pattern="csv")
dat <- read.csv("kwrt_weather_drought_1888_2014_p141_output_grids_emast.csv")
head(dat)
tail(dat)

dat$raster_layer <- as.character(dat$gridname)
dat$date <- matrix(unlist(strsplit(dat$raster_layer, "_")), ncol = 2, byrow=TRUE)[,2]
head(dat)
dat$date <- gsub(".tif","",dat$date)
head(dat )
dat$date <- paste(substr(dat$date,1,4), substr(dat$date,5,6), 1, sep = "-")
head(dat )
dat$year <- substr(dat$date,1,4)
dat$month <- substr(dat$date,6,7)
dat$year <- as.numeric(dat$year)
dat$month <- as.numeric(dat$month)
dat$date <- as.Date(dat$date)
str(dat)


qc <- dat


require(HutchinsonDroughtIndex)
qc$rain <- qc$values
as.data.frame(table(qc$year))
indat <- qc[,c("date","year","month","rain")]
str(indat)
indat[(nrow(indat) - 20):nrow(indat),]


drt <- drought_index_stations(data=indat,
                              years=length(names(table(indat$year)))
)
head(drt)
tail(drt)
str(drt)
qc3 <- drt[drt$year>=1979 & drt$year < 1984,]

png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output_emast.png"))
par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
plot(qc3$date,qc3$rain,type='l',main='Prospect Reservoir (67019) NSW: raw monthly rainfall')
#points(qc3$date,qc3$rain)

lines(qc3$date,qc3$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
points(qc3$date,qc3$sixmnthtot/6)

plot(qc3$date,qc3$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
points(qc3$date,qc3$index)
segments(min(qc3$date),-1,max(qc3$date),-1)
segments(min(qc3$date),0,max(qc3$date),0,lty=2)
plot(qc3$date,qc3$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
points(qc3$date,qc3$count)
segments(min(qc3$date),5,max(qc3$date),5)

plot(qc3$date,qc3$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
points(qc3$date,qc3$count2)
segments(min(qc3$date),5,max(qc3$date),5)
dev.off()



```

## Results

### Combine the three time-series

```{r, echo = F, results = 'hide', eval = F}
indir1 <- 'data/ad_hoc'
dir(indir1)
infile1 <- 
file.path(indir1,'ProspectReservoir06719Drought8283.csv')
dir(pattern="csv")
infile2 <- "kwrt_weather_drought_1888_2014_p141_output.csv"            
infile3 <- "kwrt_weather_drought_1888_2014_p141_output_grids_emast.csv"

dat <- read.csv(infile1)

```

### Compare the results

Shown in Figure Y is the results

![alttext](kwrt_weather_drought_1888_2014_p141_output3.png)

## Conclusions

The end

## References

```{r, results = 'asis', echo = FALSE, eval = F}
bibliography()
```
