
---
title: "kwrt weather drought 1888 2014 p141"
author: Ivan C. Hanigan
output:
  html_document:
    toc: true
    theme: united
    number_sections: no    
  pdf_document:
    toc: true
    toc_depth: 3
    highlight: zenburn
    keep_tex: true
    number_sections: no        
documentclass: article
classoption: a4paper
---


  
```{r echo = F, eval=F, results="hide"}
# func
setwd("~/data/HutchinsonDroughtIndex/reports/")
library(rmarkdown)
library(knitr)
library(knitcitations)
cleanbib()
options("cite_format"="pandoc")
rmarkdown::render("kwrt_weather_drought_1888_2014_p141.Rmd", "all")
# browseURL("hanigan-synthesis.html")
system("pandoc -V papersize:'a4paper' -i hanigan-synthesis.html -o hanigan-synthesis.docx")
```
```{r, echo = F, results = 'hide'}
# load
if(!exists("bib")){
bib <- read.bibtex("~/references/library.bib")
}
```

## Introduction

This is the code to calculate the Drought Data for the Hutchinson Drought Index  `r citet(bib[["Kokic2006a"]])` application to the Woodland Restoration Plot Network.

First do a quality assurance test with the Prospect Reservoir data, then apply to the woodland restoration plot network spatial locations.

## Data Source

- The Bureau of Meteorology has generated a range of gridded meteorological datasets for Australia as a contribution to the Australian Water Availability Project (AWAP). These include monthly precipitation from 1900 to the present.
- [http://www.bom.gov.au/jsp/awap/](http://www.bom.gov.au/jsp/awap/)
- Documentation is at [http://www.bom.gov.au/amm/docs/2009/jones.pdf](http://www.bom.gov.au/amm/docs/2009/jones.pdf)


```{r, echo = F, eval = F, results = 'hide'}
#### install dependencies
library(disentangle)
require(swishdbtools)
if(!require(raster)) install.packages("raster", dependencies = T); require(raster)
if(!require(rgdal)) install.packages("rgdal", dependencies = T); require(rgdal)
library(sqldf)  
# on linux can install direct, on windoze you configure Rtools
#require(devtools)
#install_github("swish-climate-impact-assessment/awaptools")
require(awaptools)
#install_github("ivanhanigan/HutchinsonDroughtIndex")

homedir <- "~/data/HutchinsonDroughtIndex/reports"
outdir <- "/ResearchData/AWAP_GRIDS_RAIN_MONTHLY"
 
# first make sure there are no left over files from previous runs
#oldfiles <- list.files(pattern = '.tif', full.names=T) 
#for(oldfile in oldfiles)
#{
#  print(oldfile)
#  file.remove(oldfile)
#}
################################################
setwd(homedir)
 
# local customisations
workdir  <- outdir
setwd(workdir)
dir()
# don't change this
# years <- c(2013:2014)
# lengthYears <- length(years)
# change this
startdate <- "2014-01-01"
enddate <- "2014-12-31"
# do
load_monthly(start_date = startdate, end_date = enddate)
 
# do
filelist <- dir(pattern = "grid.Z$")
filelist
for(fname in filelist)
{
  #fname <- filelist[1]
  unzip_monthly(fname, aggregation_factor = 1)
  fin <- gsub(".grid.Z", ".grid", fname)
  fout <- gsub(".grid.Z", ".tif", fname)
  r <- raster(fin)
  writeRaster(r, fout, format="GTiff",  overwrite = TRUE)
  file.remove(fin)
}
 
cfiles <- list.files(pattern = '.tif', full.names=T) 
matrix(cfiles)
```

## Methods

The Drought index is shown in Figure
X for the SD of Central West NSW
during a period which includes a strong drought (1979-83). The raw
monthly rainfall totals are integrated to rolling 6-monthly totals
(both shown in first panel) which are then ranked into percentiles by
month and this is rescaled to range between -4 and +4 in keeping with
the range of the Palmer Index Palmer1965 (second panel). Mild
drought is below -1 in the Palmer index and so consecutive months
below this threshold are counted. In the original method 5 or more
consecutive months was defined as the beginning of a drought, which
continued until the rescaled percentiles exceed -1 again (third
panel). The enhanced method imposes a more conservative threshold of
zero (the median) to break a drought (fourth panel).  There was also
an alternative method devised by Hutchinson where the rescaled
percentile values are integrated using conditional cumulative
sums.

## Results

Shown in Figure Y is the results

![alttext](kwrt_weather_drought_1888_2014_p141_output3.png)

```{r, echo = F, eval = F, results = 'hide'}
library(awaptools)
library(swishdbtools)
library(gisviz)
if(!library(raster)) install.packages('raster'); library(raster)
library(sqldf)

homedir <- "~/data/HutchinsonDroughtIndex/reports"
outdir <- "/ResearchData/AWAP_GRIDS_RAIN_MONTHLY"
setwd(outdir)

locn <- geocode("PROSPECT RESERVOIR NSW")
epsg <- make_EPSG()
shp <- SpatialPointsDataFrame(cbind(locn$lon,locn$lat),locn,
                              proj4string=CRS(epsg$prj4[epsg$code %in% '4283']))
shp@data 
##        lon       lat
## 1 150.8929 -33.82107

cfiles <-  dir(pattern="tif$")
cfiles[1:10]
tail(cfiles)
for(i in seq_len(length(cfiles))){
  #i <- 1 ## for stepping thru
  gridname <- cfiles[[i]]
  r <- raster(gridname)
  e <- extract(r, shp, df=T)
  e1 <- shp
  e1@data$values <- e[,2]
  e1@data$gridname <- gridname
  # e1@data
  # write to to target file
  write.table(e1@data, file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output.csv"),
    col.names = i == 1, append = i>1 , sep = ",", row.names = FALSE)
}
dat <- read.csv(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output.csv"))
head(dat)
tail(dat)
qc2 <- read.csv("~/data/HutchinsonDroughtIndex/data/ad_hoc/IDCJAC0001_067019_Data1.csv")
names(qc2) <- lcu(names(qc2))
head(qc2)
tail(qc2)
dat$raster_layer <- as.character(dat$gridname)
dat$date <- matrix(unlist(strsplit(dat$raster_layer, "_")), ncol = 2, byrow=TRUE)[,2]
head(dat)
dat$date <- gsub(".tif","",dat$date)
head(dat )
dat$date <- paste(substr(dat$date,1,4), substr(dat$date,5,6), substr(dat$date,7,8), sep = "-")
head(dat )
dat$year <- substr(dat$date,1,4)
dat$month <- substr(dat$date,6,7)
dat$year <- as.numeric(dat$year)
dat$month <- as.numeric(dat$month)
dat$date <- as.Date(dat$date)
str(dat)

qc <- dat
qc3 <- sqldf("select * from qc left join qc2 on qc.year = qc2.year and
  qc.month = qc2.month")
head(qc3)
tail(qc3)

png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output1.png"))
with(qc3, plot(monthly_precipitation_total_millimetres_, values))
dev.off()

png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output2.png"))
with(qc3, plot(as.Date(date), values, type = "l"))
with(qc3, lines(as.Date(date), monthly_precipitation_total_millimetres_, col = "blue"))
dev.off()

qc3[is.na(qc3$monthly_precipitation_total_millimetres_),]

require(HutchinsonDroughtIndex)

qc4 <- sqldf("select * from qc3 where year < 2013")
head(qc4);tail(qc4)
qc4$rain <- qc4$values
as.data.frame(table(qc4$year))
indat <- qc4[,c("date","year","month","rain")]
str(indat)
indat[(nrow(indat) - 20):nrow(indat),]


drt <- drought_index_stations(data=indat,
years=length(names(table(indat$year)))
)
head(drt)
tail(drt)
str(drt)
qc3 <- drt[drt$year>=1979 & drt$year < 1984,]

png(file.path(homedir,"kwrt_weather_drought_1888_2014_p141_output3.png"))
par(mfrow=c(4,1),mar=c(2.5,2,1.5,1))
 plot(qc3$date,qc3$rain,type='l',main='Prospect Reservoir (67019) NSW: raw monthly rainfall')
 #points(qc3$date,qc3$rain)
 
 lines(qc3$date,qc3$sixmnthtot/6, lwd = 2) #,type='l',main='6-monthly total rainfall')
 points(qc3$date,qc3$sixmnthtot/6)
 
 plot(qc3$date,qc3$index,type='l',main='Rescaled percentiles -4 to +4, -1 is Palmer Index Mild Drought',ylim=c(-4,4))
 points(qc3$date,qc3$index)
 segments(min(qc3$date),-1,max(qc3$date),-1)
 segments(min(qc3$date),0,max(qc3$date),0,lty=2)
 plot(qc3$date,qc3$count,type='l',main='Counts below -1 threshold, count of 5 or more is a drought')
 points(qc3$date,qc3$count)
 segments(min(qc3$date),5,max(qc3$date),5)
 
 plot(qc3$date,qc3$count2,type='l',main='Enhanced counts of months if already passed count of 5 and percentiles less than 50%')
 points(qc3$date,qc3$count2)
 segments(min(qc3$date),5,max(qc3$date),5)
dev.off()


```

## Conclusions

The end

## References

```{r, results = 'asis', echo = FALSE}
bibliography()
```
